// ... –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–¥ —Å—Ç–∏–ª–µ–π –∏ —Ä–∞–∑–º–µ—Ç–∫–∏ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ...

<script>
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Supabase
    const SUPABASE_CONFIG = {
        url: 'https://ncwejzjbgpjdzeiqolks.supabase.co',
        key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5jd2VqempiZ3BqZHplaXFvbGtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3NTg0NjgsImV4cCI6MjA3NTMzNDQ2OH0.NaaEVVEyz444wMJcty4mjrsUs4OGHJ3a3Y5d3UTikhs'
    };

    // –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –æ–±—Ö–æ–¥–∞
    const BLACKLIST = [
        '–¥–æ–∫—Å', 'dokc', 'd–æ–∫—Å', '—Ä–∏–∞–Ω–æ—á–∫–∞', '—Ä–∏–∞–Ω–æ—á–∫–µ', '—Ä–∏–∞–Ω–æ—á–∫–∏', 
        '–µ–±–∞—Ç—å', '—Ö—É–π–Ω—è', '–±–ª—è—Ç—å', '666 –ª–∞–π–∫–æ–≤', '666–ª–∞–π–∫–æ–≤',
        '–≤–∑–ª–∞–º—ã–≤–∞—é—Ç', '—Ö–∞–∫', 'hack', '–≤–∑–ª–æ–º', 'hackers', '—Ö–∞–∫–µ—Ä—ã',
        '—Ñ–ª—É–¥', '—Å–ø–∞–º', '–±–æ—Ç—ã', '–æ–±—Ö–æ–¥', '—É—è–∑–≤–∏–º–æ—Å—Ç—å', 'localstorage',
        'script', 'javascript', 'alert', 'document.cookie', 'eval',
        '—Ñ–ª—É–¥–∏—Ç—å', '–∑–∞—Å–ø–∞–º–∏—Ç—å', '–±–æ—Ç–Ω–µ—Ç', 'ddos', 'sql injection',
        'sql –∏–Ω—ä–µ–∫—Ü–∏—è', 'xss', 'csrf', '–≤–∑–ª–æ–º –±–∞–∑—ã', '–≤–∑–ª–æ–º —Å–∞–π—Ç–∞',
        '–∞—Ç–∞–∫–∞', 'dos', '–æ—Ç–∫–∞–∑ –≤ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏', 'bruteforce',
        '–ø–∞—Ä–æ–ª—å', '–≤–∑–ª–æ–º–∞—Ç—å –ø–∞—Ä–æ–ª—å', '–≤–∑–ª–æ–º–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç', '—Ö–∞–∫–Ω—É—Ç—å',
        '—É—è–∑–≤–∏–º–æ—Å—Ç—å —Å–∞–π—Ç–∞', '—É—è–∑–≤–∏–º–æ—Å—Ç—å –±–∞–∑—ã', '–±–∞–≥', '—ç–∫—Å–ø–ª–æ–π—Ç',
        'exploit', 'backdoor', '–±—ç–∫–¥–æ—Ä', '—Ä—É—Ç–∫–∏—Ç', 'rootkit',
        '–≤–∏—Ä—É—Å', '—Ç—Ä–æ—è–Ω', 'malware', '–≤—Ä–µ–¥–æ–Ω–æ—Å', '—à–ø–∏–æ–Ω',
        '–∫—Ä–∞–∂–∞ –¥–∞–Ω–Ω—ã—Ö', '—É—Ç–µ—á–∫–∞ –¥–∞–Ω–Ω—ã—Ö', '—Å–ª–∏–≤ –¥–∞–Ω–Ω—ã—Ö',
        '–ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ', '–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ', '–ø–∞—Å–ø–æ—Ä—Ç',
        '–∫–∞—Ä—Ç–∞', '–∫—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞', '–±–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞',
        '—Å—á–µ—Ç', '–∫–æ—à–µ–ª–µ–∫', '–∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞', '–±–∏—Ç–∫–æ–∏–Ω',
        '—ç—Ñ–∏—Ä', 'ether', 'crypto', 'wallet', 'wallet hack'
    ];

    // –ö–ª–∞—Å—Å –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç —Ñ–ª—É–¥–∞
    class FloodProtection {
        constructor() {
            this.userActions = new Map();
            this.maxActions = {
                post: 3,
                comment: 10,
                vote: 30
            };
        }

        canPerformAction(userId, actionType) {
            const now = Date.now();
            const userActions = this.userActions.get(userId) || {};
            const actionTimes = userActions[actionType] || [];
            
            const recentActions = actionTimes.filter(time => now - time < 60000);
            
            if (recentActions.length >= this.maxActions[actionType]) {
                return false;
            }
            
            recentActions.push(now);
            userActions[actionType] = recentActions;
            this.userActions.set(userId, userActions);
            
            return true;
        }

        isSuspiciousActivity(userId) {
            const userActions = this.userActions.get(userId);
            if (!userActions) return false;
            
            const totalActions = Object.values(userActions).flat().length;
            return totalActions > 50;
        }

        clearOldEntries() {
            const now = Date.now();
            for (const [userId, actions] of this.userActions.entries()) {
                for (const [actionType, times] of Object.entries(actions)) {
                    const recentTimes = times.filter(time => now - time < 60000);
                    if (recentTimes.length === 0) {
                        delete actions[actionType];
                    } else {
                        actions[actionType] = recentTimes;
                    }
                }
                if (Object.keys(actions).length === 0) {
                    this.userActions.delete(userId);
                }
            }
        }
    }

    // –ö–ª–∞—Å—Å –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    class InputValidator {
        static sanitizeText(text) {
            if (typeof text !== 'string') return '';
            
            return text
                .trim()
                .substring(0, 1000)
                .replace(/[<>]/g, '')
                .replace(/\s+/g, ' ')
                .replace(/javascript:/gi, '')
                .replace(/on\w+=/gi, '')
                .replace(/data:/gi, '')
                .replace(/&/g, '&amp;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        static validatePost(title, content) {
            if (!title || !content) return '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
            if (title.length < 5) return '–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π';
            if (title.length > 200) return '–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π';
            if (content.length < 10) return '–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ';
            if (content.length > 2000) return '–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ';
            return null;
        }

        static validateUsername(username) {
            if (username && username.length > 20) return '–°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π –Ω–∏–∫–Ω–µ–π–º';
            if (username && !/^[a-zA-Z–∞-—è–ê-–Ø0-9\s_-]+$/.test(username)) {
                return '–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã –≤ –Ω–∏–∫–Ω–µ–π–º–µ';
            }
            return null;
        }

        static escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .toString()
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    }

    // –ö–ª–∞—Å—Å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ HTML
    class HtmlGenerator {
        static generatePostHtml(post, isAuthor, isOwner) {
            const categoryName = this.getCategoryName(post.category);
            const safeTitle = InputValidator.escapeHtml(post.title);
            const safeContent = InputValidator.escapeHtml(post.content);
            const safeAuthor = InputValidator.escapeHtml(post.author || '–ê–Ω–æ–Ω–∏–º');
            const safeTimestamp = new Date(post.timestamp).toLocaleString('ru-RU');
            
            let html = `
                <div class="post ${post.local ? 'local-post' : ''}">
                    <div class="post-header">
                        <div class="post-category">${categoryName}</div>
                        <div class="post-votes">
                            <button class="vote-btn upvote" data-post-id="${post.id}" ${post.local ? 'disabled' : ''}>‚ñ≤</button>
                            <span class="vote-count">${post.votes || 0}</span>
                            <button class="vote-btn downvote" data-post-id="${post.id}" ${post.local ? 'disabled' : ''}>‚ñº</button>
                        </div>
                        <div style="flex: 1;">
                            <h3 class="post-title">${safeTitle}</h3>
                            <div class="post-text">${safeContent}</div>
                        </div>
                    </div>
                    <div class="post-footer">
                        <div class="post-meta">
                            <small>${safeTimestamp} | üë§ ${safeAuthor}
                            ${post.local ? '<span style="color: var(--local-color); font-weight: 600;">[–õ–æ–∫–∞–ª—å–Ω—ã–π]</span>' : ''}
                            </small>
                        </div>
                        <div class="post-actions">
                            <button class="comments-btn" data-post-id="${post.id}" ${post.local ? 'disabled' : ''}>
                                üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (${post.comments ? post.comments.length : 0})
                            </button>
            `;
            
            if (isAuthor || isOwner) {
                html += `
                    <button class="delete-post-btn ${isOwner && !isAuthor ? 'owner-delete' : ''}" 
                            data-post-id="${post.id}" data-local="${post.local}">
                        üóëÔ∏è ${isOwner && !isAuthor ? '–£–¥–∞–ª–∏—Ç—å (–≤–ª–∞–¥–µ–ª–µ—Ü)' : '–£–¥–∞–ª–∏—Ç—å'}
                    </button>
                `;
            }
            
            html += `
                        </div>
                    </div>
            `;
            
            if (!post.local) {
                html += `
                    <div class="comments-section" id="comments-${post.id}">
                `;
                
                if (post.comments && post.comments.length > 0) {
                    post.comments.forEach(comment => {
                        const safeCommentAuthor = InputValidator.escapeHtml(comment.author || '–ê–Ω–æ–Ω–∏–º');
                        const safeCommentText = InputValidator.escapeHtml(comment.text);
                        const safeCommentTimestamp = new Date(comment.timestamp).toLocaleString('ru-RU');
                        
                        html += `
                            <div class="comment">
                                <div class="comment-header">
                                    ${safeCommentTimestamp} | üë§ ${safeCommentAuthor}
                                </div>
                                <div class="comment-text">${safeCommentText}</div>
                            </div>
                        `;
                    });
                } else {
                    html += '<p>–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>';
                }
                
                html += `
                        <div class="add-comment">
                            <textarea class="comment-textarea" placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." data-post-id="${post.id}"></textarea>
                            <button class="submit-comment-btn" data-post-id="${post.id}">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                        </div>
                    </div>
                `;
            }
            
            html += `</div>`;
            return html;
        }
        
        static getCategoryName(category) {
            const names = {
                'programming': '–ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ',
                'technology': '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏',
                'design': '–î–∏–∑–∞–π–Ω',
                'education': '–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ',
                'other': '–î—Ä—É–≥–æ–µ'
            };
            return names[category] || category;
        }
    }

    // –ó–∞—â–∏—â–µ–Ω–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –≤–ª–∞–¥–µ–ª—å—Ü–∞
    class OwnerManager {
        constructor(supabaseClient) {
            this.supabase = supabaseClient;
            this.ownerSession = null;
            this.sessionTimeout = 60 * 60 * 1000;
        }

        async verifyOwner(password) {
            try {
                const { data, error } = await this.supabase
                    .from('site_config')
                    .select('config_value')
                    .eq('config_key', 'owner_password')
                    .single();

                if (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è:', error);
                    return false;
                }

                if (password === data.config_value) {
                    this.ownerSession = this.generateSessionToken();
                    sessionStorage.setItem('owner_session', this.ownerSession);
                    sessionStorage.setItem('owner_session_time', Date.now().toString());
                    return true;
                }
                return false;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞—Ä–æ–ª—è:', error);
                return false;
            }
        }

        isOwner() {
            const session = sessionStorage.getItem('owner_session');
            const sessionTime = sessionStorage.getItem('owner_session_time');
            
            if (!session || !sessionTime) return false;
            
            if (Date.now() - parseInt(sessionTime) > this.sessionTimeout) {
                this.logoutOwner();
                return false;
            }
            
            return session === this.ownerSession;
        }

        generateSessionToken() {
            return 'secure_session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 16);
        }

        logoutOwner() {
            sessionStorage.removeItem('owner_session');
            sessionStorage.removeItem('owner_session_time');
            this.ownerSession = null;
        }
    }

    // –ö–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Supabase
    class SupabaseManager {
        constructor() {
            this.supabase = supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.key);
            this.localPosts = JSON.parse(localStorage.getItem('localotvet_local_posts') || '[]');
        }

        async getPosts() {
            try {
                const { data, error } = await this.supabase
                    .from('posts')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }
                
                return data.map(post => ({
                    id: post.id.toString(),
                    title: post.title,
                    content: post.content,
                    author: post.author,
                    authorId: post.author_id,
                    category: post.category,
                    timestamp: post.created_at,
                    votes: post.votes || 0,
                    comments: post.comments || [],
                    local: false
                }));
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤:', error);
                return [];
            }
        }

        async addPost(title, content, author, authorId, category) {
            try {
                if (this.containsBlacklistedWords(title + ' ' + content)) {
                    throw new Error('BLOCKED_CONTENT');
                }

                const { data, error } = await this.supabase
                    .from('posts')
                    .insert([
                        {
                            title: title,
                            content: content,
                            author: author,
                            author_id: authorId,
                            category: category,
                            votes: 0,
                            comments: []
                        }
                    ])
                    .select();

                if (error) {
                    console.error('Supabase insert error:', error);
                    throw error;
                }

                return {
                    id: data[0].id.toString(),
                    title: data[0].title,
                    content: data[0].content,
                    author: data[0].author,
                    authorId: data[0].author_id,
                    category: data[0].category,
                    timestamp: data[0].created_at,
                    votes: 0,
                    comments: [],
                    local: false
                };
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞:', error);
                throw error;
            }
        }

        async updateVotes(postId, votes) {
            try {
                const { error } = await this.supabase
                    .from('posts')
                    .update({ votes: votes })
                    .eq('id', postId);

                if (error) throw error;
                return true;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥–æ–ª–æ—Å–æ–≤:', error);
                throw error;
            }
        }

        async addComment(postId, text, author, authorId) {
            try {
                if (this.containsBlacklistedWords(text)) {
                    throw new Error('BLOCKED_CONTENT');
                }

                const { data: postData, error: getError } = await this.supabase
                    .from('posts')
                    .select('comments')
                    .eq('id', postId)
                    .single();

                if (getError) throw getError;

                const comments = postData.comments || [];
                comments.push({
                    text: text,
                    author: author,
                    authorId: authorId,
                    timestamp: new Date().toISOString()
                });

                const { error: updateError } = await this.supabase
                    .from('posts')
                    .update({ comments: comments })
                    .eq('id', postId);

                if (updateError) throw updateError;
                return comments;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è:', error);
                throw error;
            }
        }

        async deletePost(postId) {
            try {
                const { error } = await this.supabase
                    .from('posts')
                    .delete()
                    .eq('id', postId);

                if (error) throw error;
                return true;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞:', error);
                throw error;
            }
        }

        async nukeAllPosts() {
            try {
                const { error } = await this.supabase
                    .from('posts')
                    .delete()
                    .neq('id', 0);

                if (error) throw error;
                return true;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –ø–æ—Å—Ç–æ–≤:', error);
                throw error;
            }
        }

        containsBlacklistedWords(text) {
            if (!text) return false;
            
            const normalizedText = this.normalizeText(text.toLowerCase());
            const blacklistVariations = this.generateBlacklistVariations();
            
            return blacklistVariations.some(word => normalizedText.includes(word));
        }

        normalizeText(text) {
            return text
                .replace(/[0-9]/g, '')
                .replace(/[^\w\u0430-\u044f\u0410-\u042f]/g, ' ')
                .replace(/\s+/g, ' ')
                .replace(/[a]/g, '–∞')
                .replace(/[o]/g, '–æ')
                .replace(/[e]/g, '–µ')
                .replace(/[c]/g, '—Å')
                .replace(/[p]/g, '—Ä')
                .replace(/[x]/g, '—Ö')
                .replace(/[y]/g, '—É')
                .replace(/[k]/g, '–∫');
        }

        generateBlacklistVariations() {
            const variations = [];
            
            BLACKLIST.forEach(word => {
                const baseWord = word.toLowerCase();
                variations.push(baseWord);
                
                variations.push(baseWord.replace(/–∞/g, 'a'));
                variations.push(baseWord.replace(/–æ/g, 'o'));
                variations.push(baseWord.replace(/–µ/g, 'e'));
                variations.push(baseWord.replace(/—Å/g, 'c'));
                variations.push(baseWord.replace(/—Ä/g, 'p'));
                variations.push(baseWord.replace(/—Ö/g, 'x'));
                variations.push(baseWord.replace(/—É/g, 'y'));
                variations.push(baseWord.replace(/–∫/g, 'k'));
                
                variations.push(baseWord.replace(/\s/g, ''));
            });
            
            return [...new Set(variations)];
        }

        saveLocalPost(post) {
            this.localPosts.unshift(post);
            localStorage.setItem('localotvet_local_posts', JSON.stringify(this.localPosts));
            return post;
        }

        async getAllPosts() {
            const supabasePosts = await this.getPosts();
            return [...supabasePosts, ...this.localPosts].sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );
        }
    }

    // –ö–ª–∞—Å—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
    class UserManager {
        constructor(ownerManager) {
            this.userId = localStorage.getItem('localotvet_userId');
            if (!this.userId) {
                this.userId = 'user_' + Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('localotvet_userId', this.userId);
            }
            
            this.username = localStorage.getItem('localotvet_username') || '–ê–Ω–æ–Ω–∏–º';
            this.ownerManager = ownerManager;
            this.isOwner = this.ownerManager.isOwner();
            this.subscriptions = JSON.parse(localStorage.getItem('localotvet_subscriptions') || '[]');
        }

        setUsername(newUsername) {
            const validationError = InputValidator.validateUsername(newUsername);
            if (validationError) {
                throw new Error(validationError);
            }

            if (newUsername && newUsername.trim() !== '') {
                this.username = InputValidator.sanitizeText(newUsername.trim().substring(0, 20));
            } else {
                this.username = '–ê–Ω–æ–Ω–∏–º';
            }
            localStorage.setItem('localotvet_username', this.username);
        }

        async becomeOwner(password) {
            return await this.ownerManager.verifyOwner(password);
        }

        logoutOwner() {
            this.ownerManager.logoutOwner();
            this.isOwner = false;
        }

        subscribeToCategory(category) {
            if (!this.subscriptions.includes(category)) {
                this.subscriptions.push(category);
                localStorage.setItem('localotvet_subscriptions', JSON.stringify(this.subscriptions));
            }
        }

        unsubscribeFromCategory(category) {
            this.subscriptions = this.subscriptions.filter(sub => sub !== category);
            localStorage.setItem('localotvet_subscriptions', JSON.stringify(this.subscriptions));
        }

        isSubscribedTo(category) {
            return this.subscriptions.includes(category);
        }
    }

    // –ö–ª–∞—Å—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ—Å—Ç–≤–∞–º–∏
    class CommunityManager {
        constructor() {
            this.categories = {
                'programming': { 
                    name: '–ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ', 
                    icon: 'üíª', 
                    desc: '–û–±—Å—É–∂–¥–∞–µ–º —è–∑—ã–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è, —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∏ –∏ –ª—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏',
                    color: '#2563eb'
                },
                'technology': { 
                    name: '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏', 
                    icon: 'üîß', 
                    desc: '–ù–æ–≤–æ—Å—Ç–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π, –æ–±–∑–æ—Ä—ã –≥–∞–¥–∂–µ—Ç–æ–≤ –∏ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ IT-–∏–Ω–¥—É—Å—Ç—Ä–∏–∏',
                    color: '#dc2626'
                },
                'design': { 
                    name: '–î–∏–∑–∞–π–Ω', 
                    icon: 'üé®', 
                    desc: 'UI/UX –¥–∏–∑–∞–π–Ω, –≥—Ä–∞—Ñ–∏–∫–∞, –≤–µ–±-–¥–∏–∑–∞–π–Ω –∏ –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è',
                    color: '#7c3aed'
                },
                'education': { 
                    name: '–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ', 
                    icon: 'üìö', 
                    desc: '–ö—É—Ä—Å—ã, —Å–∞–º–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∏ –∫–∞—Ä—å–µ—Ä–Ω—ã–π —Ä–æ—Å—Ç –≤ IT',
                    color: '#16a34a'
                },
                'other': { 
                    name: '–î—Ä—É–≥–æ–µ', 
                    icon: 'ü§î', 
                    desc: '–í–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –ª—é–±—ã–µ —Ç–µ–º—ã',
                    color: '#64748b'
                }
            };
        }

        calculateStats(posts) {
            const stats = {};
            
            Object.keys(this.categories).forEach(category => {
                stats[category] = {
                    postCount: 0,
                    authors: new Set(),
                    lastActivity: null
                };
            });

            posts.forEach(post => {
                const category = post.category || 'other';
                if (stats[category]) {
                    stats[category].postCount++;
                    stats[category].authors.add(post.authorId);
                    
                    const postTime = new Date(post.timestamp);
                    if (!stats[category].lastActivity || postTime > stats[category].lastActivity) {
                        stats[category].lastActivity = postTime;
                    }
                }
            });

            return stats;
        }

        formatLastActivity(date) {
            if (!date) return '–Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏';
            
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffMins < 1) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
            if (diffMins < 60) return `${diffMins} –º–∏–Ω –Ω–∞–∑–∞–¥`;
            if (diffHours < 24) return `${diffHours} —á –Ω–∞–∑–∞–¥`;
            return `${diffDays} –¥–Ω –Ω–∞–∑–∞–¥`;
        }
    }

    // –û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    class LocalOtvetApp {
        constructor() {
            this.supabaseManager = new SupabaseManager();
            this.ownerManager = new OwnerManager(this.supabaseManager.supabase);
            this.userManager = new UserManager(this.ownerManager);
            this.communityManager = new CommunityManager();
            this.floodProtection = new FloodProtection();
            
            this.allPosts = [];
            this.currentCategory = 'all';
            
            this.initElements();
            this.initEventListeners();
        }

        initElements() {
            // –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            this.postsContainer = document.getElementById('postsContainer');
            this.popularPostsContainer = document.getElementById('popularPostsContainer');
            this.subscriptionsPostsContainer = document.getElementById('subscriptionsPostsContainer');
            this.communitiesGrid = document.getElementById('communitiesGrid');
            
            // –ö–Ω–æ–ø–∫–∏ –∏ —Ñ–æ—Ä–º—ã
            this.createPostBtn = document.getElementById('createPostBtn');
            this.createPostModal = document.getElementById('createPostModal');
            this.createPostForm = document.getElementById('createPostForm');
            this.submitPostBtn = document.getElementById('submitPostBtn');
            
            // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
            this.closeModalButtons = document.querySelectorAll('.close-modal');
            this.usernameModal = document.getElementById('usernameModal');
            this.usernameInput = document.getElementById('usernameInput');
            this.saveUsernameBtn = document.getElementById('saveUsernameBtn');
            this.ownerModal = document.getElementById('ownerModal');
            this.ownerPassword = document.getElementById('ownerPassword');
            this.verifyOwnerBtn = document.getElementById('verifyOwnerBtn');
            
            // –ù–∞–≤–∏–≥–∞—Ü–∏—è
            this.navLinks = document.querySelectorAll('.nav-link');
            this.mainContents = document.querySelectorAll('.main-content');
            this.homeBtn = document.getElementById('homeBtn');
            this.sidebar = document.getElementById('sidebar');
            
            // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
            this.categoryItems = document.querySelectorAll('.category-item');
            this.subscribeButtons = document.querySelectorAll('.subscribe-btn');
            
            // –ü–æ–¥–ø–∏—Å–∫–∏
            this.subscriptionsSection = document.getElementById('subscriptionsSection');
            this.subscriptionsList = document.getElementById('subscriptionsList');
            
            // –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≤–ª–∞–¥–µ–ª—å—Ü–∞
            this.becomeOwnerBtn = document.getElementById('becomeOwnerBtn');
            this.ownerTools = document.getElementById('ownerTools');
            this.logoutOwnerBtn = document.getElementById('logoutOwnerBtn');
            this.nukeDataBtn = document.getElementById('nukeDataBtn');
            this.exportDataBtn = document.getElementById('exportDataBtn');
        }

        initEventListeners() {
            // –ù–∞–≤–∏–≥–∞—Ü–∏—è
            this.navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = link.getAttribute('data-page');
                    this.showPage(pageId);
                    
                    this.navLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                });
            });

            this.homeBtn.addEventListener('click', (e) => {
                e.preventDefault();
                this.showPage('home');
                this.navLinks.forEach(l => l.classList.remove('active'));
                document.querySelector('.nav-link[data-page="home"]').classList.add('active');
            });

            // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞
            this.createPostBtn.addEventListener('click', () => {
                this.createPostModal.style.display = 'flex';
                document.getElementById('postTitle').focus();
            });

            this.createPostForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                await this.handleCreatePost();
            });

            // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∏–∫–∞
            document.getElementById('changeUsernameBtn').addEventListener('click', () => {
                this.usernameInput.value = this.userManager.username === '–ê–Ω–æ–Ω–∏–º' ? '' : this.userManager.username;
                this.usernameModal.style.display = 'flex';
            });

            this.saveUsernameBtn.addEventListener('click', () => {
                const newUsername = this.usernameInput.value.trim();
                try {
                    this.userManager.setUsername(newUsername);
                    this.updateUserDisplay();
                    this.usernameModal.style.display = 'none';
                    this.showNotification('–ù–∏–∫–Ω–µ–π–º –∏–∑–º–µ–Ω–µ–Ω', true);
                } catch (error) {
                    this.showNotification(error.message, false);
                }
            });

            // –†–µ–∂–∏–º –≤–ª–∞–¥–µ–ª—å—Ü–∞
            this.becomeOwnerBtn.addEventListener('click', () => {
                this.ownerModal.style.display = 'flex';
            });

            this.verifyOwnerBtn.addEventListener('click', async () => {
                const password = this.ownerPassword.value;
                
                if (!password) {
                    this.showNotification('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å', false);
                    return;
                }

                if (await this.userManager.becomeOwner(password)) {
                    this.ownerModal.style.display = 'none';
                    this.ownerPassword.value = '';
                    this.userManager.isOwner = true;
                    this.updateUserDisplay();
                    this.showNotification('–†–µ–∂–∏–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!', true);
                } else {
                    this.showNotification('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å', false);
                }
            });

            this.logoutOwnerBtn.addEventListener('click', () => {
                this.userManager.logoutOwner();
                this.userManager.isOwner = false;
                this.updateUserDisplay();
                this.showNotification('–†–µ–∂–∏–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω', true);
            });

            // –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            this.nukeDataBtn.addEventListener('click', async () => {
                if (confirm('‚ö†Ô∏è –í–´ –£–í–ï–†–ï–ù–´, –ß–¢–û –•–û–¢–ò–¢–ï –£–î–ê–õ–ò–¢–¨ –í–°–ï –ü–û–°–¢–´?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) {
                    try {
                        await this.supabaseManager.nukeAllPosts();
                        this.showNotification('–í—Å–µ –ø–æ—Å—Ç—ã —É–¥–∞–ª–µ–Ω—ã!', true);
                        await this.loadPosts();
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏:', error);
                        this.showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å—Ç–æ–≤', false);
                    }
                }
            });

            // –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
            this.exportDataBtn.addEventListener('click', () => {
                const dataStr = JSON.stringify(this.allPosts, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', 'localotvet_data.json');
                linkElement.click();
                
                this.showNotification('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', true);
            });

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
            this.closeModalButtons.forEach(button => {
                button.addEventListener('click', () => {
                    this.closeAllModals();
                });
            });

            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    this.closeAllModals();
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    this.closeAllModals();
                }
            });

            // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
            this.categoryItems.forEach(item => {
                item.addEventListener('click', () => {
                    this.categoryItems.forEach(cat => cat.classList.remove('active'));
                    item.classList.add('active');
                    this.currentCategory = item.getAttribute('data-category');
                    this.filterPostsByCategory();
                });
            });

            // –ü–æ–¥–ø–∏—Å–∫–∏
            this.subscribeButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const category = btn.getAttribute('data-category');
                    
                    if (this.userManager.isSubscribedTo(category)) {
                        this.userManager.unsubscribeFromCategory(category);
                        this.showNotification(`–û—Ç–ø–∏—Å–∞–ª–∏—Å—å –æ—Ç ${HtmlGenerator.getCategoryName(category)}`, true);
                    } else {
                        this.userManager.subscribeToCategory(category);
                        this.showNotification(`–ü–æ–¥–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ ${HtmlGenerator.getCategoryName(category)}`, true);
                    }
                    
                    this.updateSubscriptionsDisplay();
                });
            });
        }

        async initialize() {
            await this.loadPosts();
            this.updateUserDisplay();
            this.updateSubscriptionsDisplay();
        }

        async loadPosts() {
            try {
                this.showSyncStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤...', true);
                this.allPosts = await this.supabaseManager.getAllPosts();
                
                if (this.allPosts.length === 0) {
                    this.postsContainer.innerHTML = `
                        <div class="post">
                            <div class="post-content">
                                <p>–ü–æ–∫–∞ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ –ø–æ—Å—Ç–∞. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ —Å–æ–∑–¥–∞—Å—Ç –ø–æ—Å—Ç!</p>
                            </div>
                        </div>
                    `;
                    this.showSyncStatus('–ü–æ—Å—Ç–æ–≤ –Ω–µ—Ç. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π!', true);
                    return;
                }
                
                this.filterPostsByCategory();
                this.showSyncStatus(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${this.allPosts.length} –ø–æ—Å—Ç–æ–≤`, true);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤:', error);
                this.postsContainer.innerHTML = `
                    <div class="post">
                        <div class="post-content">
                            <p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}</p>
                        </div>
                    </div>
                `;
                this.showSyncStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤', false);
            }
        }

        updateUserDisplay() {
            const usernameDisplay = document.getElementById('usernameDisplay');
            const userAvatar = document.getElementById('userAvatar');
            const userIdDisplay = document.getElementById('userIdDisplay');
            
            if (usernameDisplay) {
                const safeUsername = InputValidator.escapeHtml(this.userManager.username);
                if (this.userManager.isOwner) {
                    usernameDisplay.innerHTML = safeUsername + '<span class="owner-badge">üëë –í–õ–ê–î–ï–õ–ï–¶</span>';
                } else {
                    usernameDisplay.textContent = safeUsername;
                }
            }
            
            if (userAvatar) {
                const initial = this.userManager.username === '–ê–Ω–æ–Ω–∏–º' ? 'A' : 
                               this.userManager.username.charAt(0).toUpperCase();
                userAvatar.textContent = initial;
                
                if (this.userManager.isOwner) {
                    userAvatar.style.backgroundColor = 'var(--owner-color)';
                    userAvatar.style.color = '#000';
                } else {
                    userAvatar.style.backgroundColor = 'var(--primary-color)';
                    userAvatar.style.color = 'white';
                }
            }
            
            if (userIdDisplay) {
                const shortId = this.userManager.userId.substring(0, 8) + '...';
                userIdDisplay.textContent = `ID: ${shortId}`;
            }

            if (this.ownerTools) {
                this.ownerTools.style.display = this.userManager.isOwner ? 'block' : 'none';
            }
        }

        updateSubscriptionsDisplay() {
            const hasSubscriptions = this.userManager.subscriptions.length > 0;
            this.subscriptionsSection.style.display = hasSubscriptions ? 'block' : 'none';
            
            if (hasSubscriptions) {
                this.subscriptionsList.innerHTML = '';
                this.userManager.subscriptions.forEach(category => {
                    const subscriptionItem = document.createElement('div');
                    subscriptionItem.className = 'subscription-item';
                    subscriptionItem.innerHTML = `
                        <span>${HtmlGenerator.getCategoryName(category)}</span>
                        <button class="go-to-posts-btn" data-category="${category}">–ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–æ—Å—Ç–∞–º</button>
                    `;
                    this.subscriptionsList.appendChild(subscriptionItem);
                });
                
                document.querySelectorAll('.go-to-posts-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const category = btn.getAttribute('data-category');
                        this.showPage('home');
                        this.categoryItems.forEach(item => item.classList.remove('active'));
                        const targetItem = document.querySelector(`.category-item[data-category="${category}"]`);
                        if (targetItem) {
                            targetItem.classList.add('active');
                            this.currentCategory = category;
                            this.filterPostsByCategory();
                        }
                    });
                });
            }
            
            this.subscribeButtons.forEach(btn => {
                const category = btn.getAttribute('data-category');
                if (this.userManager.isSubscribedTo(category)) {
                    btn.textContent = '–û—Ç–ø–∏—Å–∞—Ç—å—Å—è';
                    btn.classList.add('subscribed');
                } else {
                    btn.textContent = '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è';
                    btn.classList.remove('subscribed');
                }
            });
        }

        async handleCreatePost() {
            const title = document.getElementById('postTitle').value;
            const content = document.getElementById('postContent').value;
            const category = document.getElementById('postCategory').value;
            
            const validationError = InputValidator.validatePost(title, content);
            if (validationError) {
                this.showNotification(validationError, false);
                return;
            }
            
            if (!this.floodProtection.canPerformAction(this.userManager.userId, 'post')) {
                this.showNotification('–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ—Å—Ç–æ–≤. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ.', false);
                return;
            }
            
            if (this.floodProtection.isSuspiciousActivity(this.userManager.userId)) {
                this.showNotification('–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å. –î–æ—Å—Ç—É–ø –≤—Ä–µ–º–µ–Ω–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω.', false);
                return;
            }

            if (title && content && category) {
                await this.createPost(title, content, category);
                this.createPostForm.reset();
                this.createPostModal.style.display = 'none';
            } else {
                this.showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', false);
            }
        }

        async createPost(title, content, category) {
            try {
                this.showSyncStatus('–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞...', true);
                
                title = InputValidator.sanitizeText(title);
                content = InputValidator.sanitizeText(content);
                
                const post = await this.supabaseManager.addPost(
                    title, 
                    content, 
                    this.userManager.username, 
                    this.userManager.userId, 
                    category
                );
                
                await this.loadPosts();
                this.showNotification('–ü–æ—Å—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω', true);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞:', error);
                
                if (error.message === 'BLOCKED_CONTENT') {
                    const localPost = {
                        id: 'local_' + Date.now().toString(),
                        title: title,
                        content: '[–ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–û] ' + content,
                        author: this.userManager.username,
                        authorId: this.userManager.userId,
                        category: category,
                        timestamp: new Date().toISOString(),
                        votes: 0,
                        comments: [],
                        local: true
                    };
                    
                    this.supabaseManager.saveLocalPost(localPost);
                    await this.loadPosts();
                    this.showNotification('–ü–æ—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ (–æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞)', false);
                } else {
                    this.showNotification(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞: ${error.message}`, false);
                }
            }
        }

        showPage(pageId) {
            this.mainContents.forEach(content => {
                content.classList.remove('active');
            });
            
            document.getElementById(`${pageId}-page`).classList.add('active');
            
            if (pageId === 'home') {
                this.sidebar.style.display = 'block';
                this.filterPostsByCategory();
            } else if (pageId === 'popular') {
                this.sidebar.style.display = 'none';
                this.renderPopularPosts();
            } else if (pageId === 'communities') {
                this.sidebar.style.display = 'none';
                this.renderCommunitiesPage();
            } else if (pageId === 'subscriptions') {
                this.sidebar.style.display = 'none';
                this.renderSubscriptionsPosts();
            } else {
                this.sidebar.style.display = 'none';
            }
        }

        filterPostsByCategory() {
            if (this.currentCategory === 'all') {
                this.renderPosts(this.allPosts, this.postsContainer);
            } else {
                const filteredPosts = this.allPosts.filter(post => post.category === this.currentCategory);
                this.renderPosts(filteredPosts, this.postsContainer);
            }
        }

        renderPosts(posts, container) {
            container.innerHTML = '';
            
            if (posts.length === 0) {
                container.innerHTML = `
                    <div class="post">
                        <div class="post-content">
                            <p>–ü–æ—Å—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            posts.forEach((post) => {
                const isAuthor = post.authorId === this.userManager.userId;
                const html = HtmlGenerator.generatePostHtml(post, isAuthor, this.userManager.isOwner);
                container.innerHTML += html;
            });
            
            this.attachPostEventHandlers();
        }

        attachPostEventHandlers() {
            document.querySelectorAll('.vote-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const postId = btn.getAttribute('data-post-id');
                    const isUpvote = btn.classList.contains('upvote');
                    
                    if (!this.floodProtection.canPerformAction(this.userManager.userId, 'vote')) {
                        this.showNotification('–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≥–æ–ª–æ—Å–æ–≤. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ.', false);
                        return;
                    }
                    
                    await this.votePost(postId, isUpvote);
                });
            });
            
            document.querySelectorAll('.comments-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const postId = btn.getAttribute('data-post-id');
                    const commentsSection = document.getElementById(`comments-${postId}`);
                    if (commentsSection) {
                        commentsSection.style.display = commentsSection.style.display === 'block' ? 'none' : 'block';
                    }
                });
            });
            
            document.querySelectorAll('.submit-comment-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const postId = btn.getAttribute('data-post-id');
                    const textarea = document.querySelector(`.comment-textarea[data-post-id="${postId}"]`);
                    if (textarea) {
                        const commentText = textarea.value.trim();
                        
                        if (!commentText) {
                            this.showNotification('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è', false);
                            return;
                        }
                        
                        if (!this.floodProtection.canPerformAction(this.userManager.userId, 'comment')) {
                            this.showNotification('–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –ü–æ–¥–æ–∂–¥–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ.', false);
                            return;
                        }
                        
                        await this.addComment(postId, commentText);
                        textarea.value = '';
                    }
                });
            });
            
            document.querySelectorAll('.delete-post-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const postId = btn.getAttribute('data-post-id');
                    const isLocal = btn.getAttribute('data-local') === 'true';
                    
                    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç?')) {
                        await this.deletePost(postId, isLocal);
                    }
                });
            });
        }

        async votePost(postId, isUpvote) {
            try {
                const post = this.allPosts.find(p => p.id === postId);
                if (!post || post.local) return;
                
                let newVotes = post.votes || 0;
                if (isUpvote) {
                    newVotes += 1;
                } else {
                    newVotes = Math.max(newVotes - 1, 0);
                }
                
                await this.supabaseManager.updateVotes(postId, newVotes);
                await this.loadPosts();
                this.showNotification('–ì–æ–ª–æ—Å —É—á—Ç–µ–Ω', true);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è:', error);
                this.showNotification('–û—à–∏–±–∫–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è', false);
            }
        }

        async addComment(postId, text) {
            try {
                text = InputValidator.sanitizeText(text);
                
                await this.supabaseManager.addComment(
                    postId, 
                    text, 
                    this.userManager.username, 
                    this.userManager.userId
                );
                
                await this.loadPosts();
                this.showNotification('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω', true);
                
                const commentsSection = document.getElementById(`comments-${postId}`);
                if (commentsSection) {
                    commentsSection.style.display = 'block';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è:', error);
                
                if (error.message === 'BLOCKED_CONTENT') {
                    this.showNotification('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞', false);
                } else {
                    this.showNotification(`–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è: ${error.message}`, false);
                }
            }
        }

        async deletePost(postId, isLocal) {
            try {
                this.showSyncStatus('–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞...', true);
                
                if (isLocal) {
                    this.supabaseManager.localPosts = this.supabaseManager.localPosts.filter(
                        post => post.id !== postId
                    );
                    localStorage.setItem('localotvet_local_posts', 
                        JSON.stringify(this.supabaseManager.localPosts));
                } else {
                    await this.supabaseManager.deletePost(postId);
                }
                
                await this.loadPosts();
                this.showNotification('–ü–æ—Å—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω', true);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞:', error);
                this.showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞', false);
            }
        }

        renderPopularPosts() {
            if (this.allPosts.length === 0) {
                this.popularPostsContainer.innerHTML = `
                    <div class="post">
                        <div class="post-content">
                            <p>–ü–æ–∫–∞ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ –ø–æ—Å—Ç–∞.</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            const popularPosts = [...this.allPosts].sort((a, b) => (b.votes || 0) - (a.votes || 0));
            this.renderPosts(popularPosts, this.popularPostsContainer);
        }

        renderSubscriptionsPosts() {
            if (this.userManager.subscriptions.length === 0) {
                this.subscriptionsPostsContainer.innerHTML = `
                    <div class="post">
                        <div class="post-content">
                            <p>–£ –≤–∞—Å –Ω–µ—Ç –ø–æ–¥–ø–∏—Å–æ–∫. –ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏!</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            const subscriptionPosts = this.allPosts.filter(post => 
                this.userManager.subscriptions.includes(post.category)
            );
            
            if (subscriptionPosts.length === 0) {
                this.subscriptionsPostsContainer.innerHTML = `
                    <div class="post">
                        <div class="post-content">
                            <p>–í –≤–∞—à–∏—Ö –ø–æ–¥–ø–∏—Å–∫–∞—Ö –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤.</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            this.renderPosts(subscriptionPosts, this.subscriptionsPostsContainer);
        }

        renderCommunitiesPage() {
            if (!this.communitiesGrid) return;
            
            const stats = this.communityManager.calculateStats(this.allPosts);
            
            this.communitiesGrid.innerHTML = '';
            
            Object.entries(this.communityManager.categories).forEach(([categoryKey, categoryInfo]) => {
                const categoryStats = stats[categoryKey] || { postCount: 0, authors: new Set(), lastActivity: null };
                const authorCount = categoryStats.authors.size;
                
                const communityCard = document.createElement('div');
                communityCard.className = 'community-card';
                communityCard.setAttribute('data-category', categoryKey);
                
                communityCard.innerHTML = `
                    <div class="community-icon" style="background-color: ${categoryInfo.color}">${categoryInfo.icon}</div>
                    <h3>${InputValidator.escapeHtml(categoryInfo.name)}</h3>
                    <p>${InputValidator.escapeHtml(categoryInfo.desc)}</p>
                    <div class="community-stats">
                        <span>üìù ${categoryStats.postCount} –ø–æ—Å—Ç–æ–≤</span>
                        <span>üë• ${authorCount} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</span>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: var(--gray-color);">
                        üì¢ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${this.communityManager.formatLastActivity(categoryStats.lastActivity)}
                    </div>
                `;
                
                this.communitiesGrid.appendChild(communityCard);
            });
            
            document.querySelectorAll('.community-card').forEach(card => {
                card.addEventListener('click', () => {
                    const category = card.getAttribute('data-category');
                    this.showPage('home');
                    this.navLinks.forEach(l => l.classList.remove('active'));
                    document.querySelector('.nav-link[data-page="home"]').classList.add('active');
                    this.categoryItems.forEach(item => item.classList.remove('active'));
                    const categoryItem = document.querySelector(`.category-item[data-category="${category}"]`);
                    if (categoryItem) {
                        categoryItem.classList.add('active');
                        this.currentCategory = category;
                        this.filterPostsByCategory();
                    }
                    this.showSyncStatus(
                        `–ü–æ–∫–∞–∑–∞–Ω—ã –ø–æ—Å—Ç—ã –∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: ${this.communityManager.categories[category].name}`, 
                        true
                    );
                });
            });
        }

        closeAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        }

        showNotification(message, isSuccess) {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${isSuccess ? 'var(--success-color)' : 'var(--danger-color)'};
                color: white;
                padding: 12px 20px;
                border-radius: var(--radius);
                box-shadow: var(--shadow-lg);
                z-index: 1001;
                font-weight: 500;
                max-width: 300px;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        showSyncStatus(message, isSuccess) {
            const syncStatus = document.getElementById('syncStatus');
            if (syncStatus) {
                syncStatus.textContent = message;
                syncStatus.style.cssText = `
                    padding: 8px 12px;
                    border-radius: var(--radius);
                    font-size: 13px;
                    text-align: center;
                    margin-bottom: 12px;
                    background: ${isSuccess ? '#dcfce7' : '#fecaca'};
                    color: ${isSuccess ? '#166534' : '#991b1b'};
                    border: 1px solid ${isSuccess ? '#bbf7d0' : '#fca5a5'};
                `;
                
                setTimeout(() => {
                    syncStatus.textContent = '';
                    syncStatus.style.cssText = '';
                }, 5000);
            }
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    document.addEventListener('DOMContentLoaded', async () => {
        const app = new LocalOtvetApp();
        await app.initialize();
    });
</script>
</body>
</html>
